services:
  nfs_server:
    image: ghcr.io/cloudx-labs/nfs-server:latest
    container_name: nfs-server-test
    privileged: true
    volumes:
      - nfs_data:/exports
    ports:
      - "2049:2049"
      - "20048:20048"
    healthcheck:
      test: ["CMD", "rpcinfo", "-u", "localhost", "nfs", "3"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  nfs_client:
    image: debian:12-slim
    container_name: nfs-client-test
    privileged: true
    depends_on:
      nfs_server:
        condition: service_healthy
    command:
      - /bin/sh
      - -c
      - |
        set -eu
        apt-get update
        apt-get install -y --no-install-recommends nfs-common
        mkdir -p /mnt/nfs
        mount -t nfs -o vers=3,timeo=5,retrans=2,nolock nfs_server:/exports /mnt/nfs
        hostname > /mnt/nfs/test-client.txt
        printf 'NFS file contains: '
        cat /mnt/nfs/test-client.txt
        ls -al /mnt/nfs
        umount /mnt/nfs

volumes:
  nfs_data:
